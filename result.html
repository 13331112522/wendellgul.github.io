<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width,initial-scale=0.5, maximum-scale=0.5, minimum-scale=0.5, user-scalable=no">
    <meta name="x5-fullscreen" content="true">
    <meta name="full-screen" content="yes">
    <title>Search Result</title>
    <link rel="stylesheet" href="lib/bootstrap-4.0.0-dist/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <link rel="stylesheet" type="text/css" href="lib/font-awesome/css/font-awesome.min.css">
    <style>
    .hide {
        display: none;
    }

    .search {
        top: 0%;
        padding: 8px;
        left: 51%;
    }

    #search {
        top: 6px;
    }

    #search_text {
        height: 45px;
    }

    .searchFail {
        text-align: center; /*让div内部文字居中*/
        width: 800px;
        height: 350px;
        margin: auto;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    #failText {
        font-size: 50px;
    }
    </style>
</head>

<body>
    <header>
        <div class="navbar navbar-dark box-shadow" style="background-color: black;">
            <div class="container d-flex justify-content-between">
                <a href="index.html" class="navbar-brand d-flex align-items-center">
                    <i class="fa fa-book"></i>
                    <strong>&nbsp; Nebulas Scholar</strong>
                </a>
                <div class="search bar">
                    <input type="text" id="search_text" autocomplete="off" placeholder="   Please input the title...">
                    <button type="submit" id="search" onclick="add_search()"></button>
                </div>
            </div>
        </div>
    </header>
    <div class="main">
        <div class="noExtension hide" id="noExtension">
            NOTE: Please install <a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a> to use Nebulas Scholar
        </div>
        <div class="center">
            <div id="result">
            </div>
        </div>
        <div class="searchFail hide">
            <p id="failText"></p>
        </div>
    </div>
    <footer class="footer text-center">
        <p>Copyright &copy; 2018 Wendell</p>
    </footer>
    <script src=lib/jquery-3.3.1.min.js></script>
    <script src=lib/nebPay.js></script>
    <script src=lib/bootstrap-4.0.0-dist/js/bootstrap.min.js></script>
    <script src=lib/nebulas.js></script>
    <script type="text/javascript" src="lib/jquery.tmpl.js"></script>
    <script type="text/x-jquery-tmpl" id="template-results">
        <div class="card-item">
            <div class="item-title">
                <a class="title" href="${link}">${title}</span>
            </div>
            <div class="item-authors">
                <span class="authors">Authors: </span>
                <span class="authors value">${authors}</span>
            </div>
            <div class="item-keywords">
                <span class="keywords">Keywords: </span>
                <span class="keywords value">${keywords}</span>
            </div>
            <div class="item-abstract">
                <span class="abstract">Abstract: </span>
                <span class="abstract value">${abstract}</span>
            </div>
            <div class="item-publish">
                <span class="publish">Publish: </span>
                <span class="publish value">${publish}</span>
            </div>
            <div class="item-date">
                <span class="date">Date: </span>
                <span class="date value">${date}</span>
            </div>
            <div>============================================</div>
            
        </div>
    </script>

    <script>
    "use strict";

    var dappAddress = "n1uypoJ8dt6k66PiLyV5353DWkudwiwsZ2K";
    var idxAddress = "n1uGnX9sKhTQVfgrsJFy4GyBC5S6kt7iqHr";

    //here we use neb.js to call the "get" function to search from the Dictionary
    var nebulas = require("nebulas"),
        Account = nebulas.Account,
        neb = new nebulas.Neb();
    neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));

    function getParams(key) {
        var reg = new RegExp("(^|&)" + key + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) {
            return unescape(r[2]);
        }
        return null;
    };

    var search_text = getParams("search_text");
    $("#search_text").val(search_text);

    search_idx();


    function add_search() {
        var url = "result.html?search_text=" + $("#search_text").val();
        location.href = url;
    }


    function search_idx() {
        var from = Account.NewAccount().getAddressString();

        var value = "0";
        var nonce = "0"
        var gas_price = "1000000"
        var gas_limit = "2000000"
        var callFunction = "get";
        //var callArgs = "[\"" + $("#search_value").val() + "\"]"; //in the form of ["args"]
        var args = $("#search_text").val().split(/ +/);
        var callArgs = JSON.stringify([args]);
        console.log(callArgs)
        var contract = {
            "function": callFunction,
            "args": callArgs
        }

        neb.api.call(from, idxAddress, value, nonce, gas_price, gas_limit, contract).then(function(resp) {
            cbSearchIdx(resp);
        }).catch(function(err) {
            //cbSearch(err)
            console.log("index error:" + err.message)
        });

    }

    // 搜索功能
    function search(keys) {
        // $("#search_value").val() 搜索框内的值

        var from = Account.NewAccount().getAddressString();

        var value = "0";
        var nonce = "0"
        var gas_price = "1000000"
        var gas_limit = "2000000"
        var callFunction = "getMany";
        //var callArgs = "[\"" + $("#search_value").val() + "\"]"; //in the form of ["args"]

        var data = [];

        var callArgs = JSON.stringify([keys]);

        console.log(callArgs);
        var contract = {
            "function": callFunction,
            "args": callArgs
        }

        neb.api.call(from, dappAddress, value, nonce, gas_price, gas_limit, contract).then(function(resp) {
            cbSearch(resp)
        }).catch(function(err) {
            //cbSearch(err)
            console.log("data error:" + err.message)
        });

    }

    function cbSearchIdx(resp) {
        var result = resp.result ////resp is an object, resp.result is a JSON string
        console.log("return of search index call: " + JSON.stringify(result))

        var resultString = JSON.stringify(result);

        if (resultString.search("null") !== -1 || resultString.search("error") !== -1) {
            $(".searchFail").removeClass("hide");
            $("#failText").text("Oooops! Nothing to be found!");
        } else {
            result = JSON.parse(result)
            var keys = []
            for (var i = 0; i < result.length; i++) {
                keys.push(result[i]);
            }
            console.log(keys);
            search(keys);
        }

    }

    //return of search,
    function cbSearch(resp) {
        var result = resp.result ////resp is an object, resp.result is a JSON string
        console.log("return of search data call: " + JSON.stringify(result))
        result = JSON.parse(result)
        var find = false
        for(var r of result) {
            if(r) {
                console.log(r)
                $("#template-results").tmpl(r).appendTo("#result")
                find = true
            }
        }
        if (!find) {
            $(".searchFail").removeClass("hide");
            $("#failText").text("Oooops! Nothing to be found!");
        }        
    }
    </script>
</body>

</html>